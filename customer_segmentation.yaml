entity: model/Transform:v1
name: Customer Segmentation Analysis
identifier: customer-segmentation-analysis
description: Segment customers based on order frequency and total spend
tags:
- monthly
- daily
database: Sample Database
target:
  type: table
  name: customer_segments
source: |
  SELECT 
      o.user_id,
      COUNT(o.id) as total_orders,
      SUM(o.total) as total_spent,
      AVG(o.total) as avg_order_value,
      MIN(o.created_at) as first_order,
      MAX(o.created_at) as last_order,
      DATEDIFF(MAX(o.created_at), MIN(o.created_at)) as customer_lifetime_days,
      COUNT(DISTINCT p.category) as categories_purchased,
      CASE 
          WHEN COUNT(o.id) >= 10 AND SUM(o.total) >= 1000 THEN 'vip'
          WHEN COUNT(o.id) >= 5 AND SUM(o.total) >= 500 THEN 'frequent'
          WHEN COUNT(o.id) >= 2 AND SUM(o.total) >= 100 THEN 'regular'
          ELSE 'occasional'
      END as customer_segment,
      CASE 
          WHEN MAX(o.created_at) >= CURRENT_DATE - INTERVAL '30 days' THEN 'active'
          WHEN MAX(o.created_at) >= CURRENT_DATE - INTERVAL '90 days' THEN 'at_risk'
          ELSE 'churned'
      END as activity_status
  FROM ORDERS o
  JOIN PRODUCTS p ON o.product_id = p.id
  GROUP BY o.user_id
  ORDER BY total_spent DESC
